<Lems>

    <!-- Simple cell with Sodium, Potassium and Calcium channels and
    an exponentially decaying Calcium pool. The Calcium current due to the
    channels is calculated using the GHK field equation, and the Na
    reversal potential is obtained from the Nernst equation. -->


    <!-- Specify which component to run -->
    <Target component="sim1"/>

    <!-- Include core NeuroML2 ComponentType definitions -->
    <Include file="./Cells.xml"/>
    <Include file="Networks.xml"/>
    <Include file="Simulation.xml"/>

    <ionChannel id="leak" type="ionChannelPassive" conductance="10pS" species="non_specific"/>
    
    <ionChannel id="na_chan" type="ionChannelHH" conductance="10pS" species="na">
       <gateHHrates id="m" instances="3">
            <q10Settings type="q10ExpTemp" q10Factor="3" experimentalTemp="6.3 degC"/>
            <forwardRate type="HHExpLinearRate" rate="1per_ms" midpoint="-40mV" scale="10mV"/>
            <reverseRate type="HHExpRate" rate="4per_ms" midpoint="-65mV" scale="-18mV"/>
       </gateHHrates>
    
       <gateHHrates id="h" instances="1">
           <q10Settings type="q10ExpTemp" q10Factor="3" experimentalTemp="6.3 degC"/>
           <forwardRate type="HHExpRate" rate="0.07per_ms" midpoint="-65mV" scale="-20mV"/>
           <reverseRate type="HHSigmoidRate" rate="1per_ms" midpoint="-35mV" scale="10mV"/>
       </gateHHrates>
    </ionChannel>

    <ionChannel id="k_chan" type="ionChannelHH" conductance="10pS" species="k">
        <gateHHrates id="n" instances="4">
            <q10Settings type="q10ExpTemp" q10Factor="3" experimentalTemp="6.3 degC"/>
            <forwardRate type="HHExpLinearRate" rate="0.1per_ms" midpoint="-55mV" scale="10mV"/>
            <reverseRate type="HHExpRate" rate="0.125per_ms" midpoint="-65mV" scale="-80mV"/>
        </gateHHrates>
    </ionChannel>

    <ionChannel id="ca_chan" type="ionChannelHH" conductance="10pS" species="ca">
        <gateHHrates id="p" instances="2">
	  <!-- the nrn example uses a hardcoded "taufactor", disregarding the q10 calculations -->
          <q10Settings type="q10Fixed" fixedQ10="0.5" experimentalTemp="6.3 degC"/>
          <forwardRate type="HHExpLinearRate" rate="1per_ms" midpoint="-40mV" scale="10mV"/>
          <reverseRate type="HHExpRate" rate="4per_ms" midpoint="-65mV" scale="-18mV"/>
        </gateHHrates>
    </ionChannel>
    
    <concentrationModel id="simple_decay" type="fixedFactorConcentrationModel"
                         restingConc="3e-6 mM"
                         decayConstant="1.0 ms"
                         <!-- phi="8.4E-6 mol_per_m3_per_A_per_s"/> -->
                         <!-- phi="8.4E6 mol_per_m3_per_A_per_s"/> -->
                         phi="9.54929658551e-02 mmolar_per_nA_per_ms"/>


    <cell id="na_k_ca">

        <notes>Sample cell with HH Na/K and a Ca channel/buffer to test the GHK ComponentType</notes>

        <morphology id="just_a_cylinder">

            <segment id="0" name="Soma">
                <proximal x="0.0" y="0.0" z="0.0" diameter="1.0"/>
                <distal x="0.0" y="0.0" z="10.0" diameter="1.0"/>
            </segment>

            <segmentGroup id="Soma">
                <member segment="0"/>
            </segmentGroup>

            <segmentGroup id="all">
                <include segmentGroup="Soma"/>
            </segmentGroup>

            <segmentGroup id="soma_group">
                <include segmentGroup="Soma"/>
            </segmentGroup>

            
        </morphology>

        <!--Adding the biophysical parameters-->

        <biophysicalProperties id="biophys">

            <membraneProperties>

                <channelDensity condDensity="0.12 S_per_cm2" id="na_all" ionChannel="na_chan" erev="50.8 mV" ion="na"/>
                <channelDensity condDensity="0.036 S_per_cm2" id="k_all" ionChannel="k_chan" erev="-77.0 mV" ion="k"/>
                <channelDensity condDensity="0.0003 S_per_cm2" id="passive" ionChannel="leak" erev="-53.1 mV" ion="non_specific"/>
                <!-- <channelDensityGHK permeability="2.5e-5 m_per_s" id="ca_all" ionChannel="ca_chan" ion="ca"/> -->
                <channelDensityGHK permeability="2.5e-8 m_per_s" id="ca_all" ionChannel="ca_chan" ion="ca"/>
                <!-- <channelDensityNernst condDensity="2.5e-5 S_per_cm2" id="ca_all" ionChannel="ca_chan" ion="ca"/> -->

                <spikeThresh value="0 mV"/>

                <specificCapacitance value="1.0 uF_per_cm2"/>

                <initMembPotential value="-65.0 mV"/>

            </membraneProperties>


            <intracellularProperties>

                <species id="ca"
                         ion="ca"
                         concentrationModel="simple_decay"
                         initialConcentration="3e-6 mM"
                         initialExtConcentration="2 mM"/>

                <resistivity value="0.1 kohm_cm"/>

            </intracellularProperties>

        </biophysicalProperties>

    </cell>


    <pulseGenerator id="IClamp" delay="4ms" duration="0.1ms" amplitude="0.05nA" />


    <network id="net1" type="networkWithTemperature" temperature = "16.3 degC">
        <population id="pop" component="na_k_ca" size="1"/>
        <explicitInput target="pop[0]" input="IClamp"/>
    </network>


    <!-- End of NeuroML2 content -->


    <Simulation id="sim1" length="10ms" step="0.001ms" target="net1">

        <Display id="d1" title="Membrane Potential" timeScale="1ms" xmin="0" xmax="10" ymin="-80" ymax="40">
            <Line id="pop[0]/v" quantity="pop[0]/v" scale="1mV"  color="#ffffff" timeScale="1ms"/>
        </Display>

        <Display id="d2" title="Ca current densities (uA_per_cm2)" timeScale="1ms" xmin="0" xmax="10" ymin="-0" ymax="5">
            <Line id="Ca iDensity" quantity="pop[0]/biophys/membraneProperties/ca_all/iDensity" scale="1uA_per_cm2"  color="#00ff00" timeScale="1ms"/>
        </Display>

        <Display id="d4" title="Ca concentration (mM)" timeScale="1ms" xmin="0" xmax="10" ymin="2.95" ymax="3.05">
            <Line id="caConc" quantity="pop[0]/caConc" scale="1e-6 mM"  color="#ff0000" timeScale="1ms"/>
        </Display>

        <Display id="d5" title="Ca concentration (mM)" timeScale="1ms" xmin="0" xmax="10" ymin="0" ymax="5">
            <Line id="caConcExt" quantity="pop[0]/caConcExt" scale="1 mM"  color="#00ffff" timeScale="1ms"/>
	</Display>

        <OutputFile id="of0" fileName="/tmp/lemsica.dat">
            <OutputColumn id="ica" quantity="pop[0]/biophys/membraneProperties/ca_all/iDensity"/>
            <OutputColumn id="ca" quantity="pop[0]/caConc"/>
        </OutputFile>
        
    </Simulation>


</Lems>
